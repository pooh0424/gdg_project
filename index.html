<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>食物熱量快篩鏡 (FoodLens AI Offline)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>

    <style>
        /* CSS樣式：確保介面適合手機操作 */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #222;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* 防止滾動 */
        }

        #container {
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 視訊容器，盡量佔滿空間 */
        #video-wrapper {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            position: relative;
        }

        /* 視訊元素本身 */
        #video {
            /* 確保視訊不變形，以覆蓋方式呈現 */
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }

        /* 讀取中的遮罩層 */
        #loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 結果顯示區域 */
        #result-panel {
            width: 100%;
            padding: 20px;
            background: #fff;
            color: #333;
            border-radius: 20px 20px 0 0;
            box-shadow: 0px -5px 15px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 5;
            position: relative;
        }

        #item-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        #calorie-info {
            font-size: 1.2em;
            color: #e67e22; /* 橘色強調熱量 */
            font-weight: bold;
        }
        
        #confidence-meter {
            margin-top: 10px;
            font-size: 0.8em;
            color: #666;
        }

    </style>
</head>
<body>

<div id="container">
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">正在下載 AI 模型與權重...<br>(首次需網路，之後可離線)</div>
    </div>

    <div id="video-wrapper">
        <video id="video" autoplay playsinline muted></video>
    </div>

    <div id="result-panel">
        <div id="item-name">準備中...</div>
        <div id="calorie-info">-- kcal / 100g</div>
        <div id="confidence-meter">信心度: 0%</div>
    </div>
</div>

<script>
    // === 變數設定 ===
    const videoElement = document.getElementById('video');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const itemNameElement = document.getElementById('item-name');
    const calorieInfoElement = document.getElementById('calorie-info');
    const confidenceMeterElement = document.getElementById('confidence-meter');

    let net; // 存放載入後的 MobileNet 模型
    let isProcessing = false; // 防止重複推論

    // === 模擬的熱量資料庫 (因為 MobileNet 只會給物品名稱) ===
    // 這裡簡單列舉一些 MobileNet 可能辨識出的食物名稱
    const calorieDatabase = {
        'banana': 89,
        'apple': 52,
        'orange': 47,
        'broccoli': 34,
        'cucumber': 15,
        'hotdog': 290,
        'pizza': 266,
        'burger': 295,
        'sandwhich': 250,
        'coffee mug': 2, // 咖啡
        'water bottle': 0,
    };

    // === 核心功能 1: 啟動攝影機 ===
    async function setupCamera() {
        loadingText.innerText = "正在啟動攝影機...";
        try {
            // 要求使用後置鏡頭 (environment)
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                },
                audio: false
            });
            videoElement.srcObject = stream;
            
            // 確保視訊資料已載入才開始
            return new Promise((resolve) => {
                videoElement.onloadedmetadata = () => {
                    resolve(videoElement);
                };
            });
        } catch (e) {
            alert("無法存取攝影機，請確認權限設定。\n錯誤: " + e.message);
            throw e;
        }
    }

    // === 核心功能 2: 載入 AI 模型 (此步驟需要網路，之後會被快取) ===
    async function loadModel() {
        loadingText.innerHTML = "正在載入 MobileNet 模型...<br>(檔案較大，請耐心等候)";
        try {
            // 載入 mobilenet，這裡使用預設配置
            // 瀏覽器會自動快取這些資源
            net = await mobilenet.load();
            console.log("MobileNet model loaded successfully");
        } catch (e) {
            alert("模型載入失敗，請檢查網路連線。\n錯誤: " + e.message);
            loadingText.innerText = "模型載入失敗";
            throw e;
        }
    }

    // === 核心功能 3: 進行影像辨識與熱量估算 ===
    async function detectFrame() {
        if (!net || isProcessing) return; // 如果模型沒好或正在忙，就跳過

        isProcessing = true;
        try {
            // 使用模型對目前的視訊畫面進行分類
            // classify 接收視訊元素，回傳可能性最高的前幾個結果
            const result = await net.classify(videoElement);

            if (result && result.length > 0) {
                const topResult = result[0]; // 取信心度最高的結果
                const className = topResult.className.toLowerCase(); // 轉小寫以利比對
                const confidence = (topResult.probability * 100).toFixed(1);

                // 顯示辨識出的物品名稱 (取逗號前的第一個主要名稱)
                const displayName = topResult.className.split(',')[0];
                itemNameElement.innerText = displayName;
                confidenceMeterElement.innerText = `信心度: ${confidence}%`;

                // 估算熱量
                let estimatedCal = "未知";
                // 簡單的關鍵字匹配來尋找熱量
                for (const key in calorieDatabase) {
                    if (className.includes(key)) {
                        estimatedCal = calorieDatabase[key];
                        break;
                    }
                }

                if (estimatedCal !== "未知") {
                    calorieInfoElement.innerText = `約 ${estimatedCal} kcal / 100g`;
                    calorieInfoElement.style.color = "#e67e22";
                } else {
                    calorieInfoElement.innerText = "無法估算熱量 (非食物?)";
                    calorieInfoElement.style.color = "#999";
                }
            }
        } catch (e) {
            console.error("辨識錯誤:", e);
        } finally {
            isProcessing = false;
            // 使用 requestAnimationFrame 持續呼叫下一幀進行辨識
            // 稍微延遲一下避免手機過熱，這裡設定約每 500ms 執行一次
            setTimeout(() => {
                 requestAnimationFrame(detectFrame);
            }, 500);
           
        }
    }

    // === 主程式流程 ===
    async function main() {
        // 1. 先嘗試啟動攝影機 (使用者體驗較好)
        await setupCamera();
        videoElement.play();

        // 2. 接著載入模型
        await loadModel();

        // 3. 全部準備就緒，隱藏讀取遮罩
        loadingOverlay.style.display = 'none';

        // 4. 開始循環辨識
        detectFrame();
    }

    // 網頁載入後執行主程式
    window.addEventListener('DOMContentLoaded', main);

</script>
</body>
</html>
