<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è¦–è¦ºåˆ†æ (é›¢ç·šä¿®æ­£ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
            --accent-color: #38bdf8;
            --btn-bg: #0ea5e9;
            --btn-hover: #0284c7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h1 {
            text-align: center;
            margin: 10px 0;
            font-size: 1.5rem;
            background: linear-gradient(90deg, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar {
            background-color: var(--card-bg);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #334155;
        }

        .image-container {
            position: relative;
            width: 100%;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px dashed #334155;
        }

        .image-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #imageCanvas { z-index: 1; } 
        #maskCanvas { z-index: 2; opacity: 0.7; pointer-events: none; } 

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button, .file-btn {
            background-color: var(--btn-bg);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s;
            display: block;
        }

        button:disabled { background-color: #475569; opacity: 0.7; cursor: not-allowed; }
        button:active { transform: scale(0.98); }

        input[type="file"] { display: none; }

        .legend {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            display: none; 
        }

        .legend-title { font-size: 0.9rem; margin-bottom: 10px; color: #94a3b8; }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            font-weight: bold;
        }

        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .spinner {
            width: 30px; height: 30px;
            border: 3px solid #ffffff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘ï¸ AI èªæ„åˆ†å‰²ç›¸æ©Ÿ</h1>

    <div class="status-bar">
        <span id="statusText">ç³»çµ±å¾…å‘½ (æœªè¼‰å…¥æ¨¡å‹)</span>
        <span id="memInfo">SegFormer</span>
    </div>

    <div class="image-container" id="imgContainer">
        <div style="color: #64748b;">è«‹é¸æ“‡åœ–ç‰‡æˆ–æ‹ç…§</div>
        <canvas id="imageCanvas"></canvas>
        <canvas id="maskCanvas"></canvas>
        
        <div class="loading-overlay" id="loader">
            <div class="spinner"></div>
            <span id="loaderText">AI é‹ç®—ä¸­...</span>
        </div>
    </div>

    <div class="controls">
        <label class="file-btn">
            ğŸ“· æ‹ç…§ / é¸åœ–
            <input type="file" id="uploadInput" accept="image/*">
        </label>
        
        <button id="runBtn" disabled>â–¶ é–‹å§‹åˆ†æ</button>
    </div>

    <button id="loadBtn" style="width: 100%; margin-top: 10px; background-color: #4f46e5;">
        â¬‡ ä¸‹è¼‰æ¨¡å‹ (ç´„ 20MB)
    </button>

    <div class="legend" id="legendArea">
        <div class="legend-title">åµæ¸¬åˆ°çš„ç‰©ä»¶ï¼š</div>
        <div class="legend-items" id="legendTags"></div>
    </div>
    
    <div style="margin-top: 20px; font-size: 0.8rem; color: #64748b; text-align: center;">
        <p>åˆæ¬¡éœ€é€£ç¶²ï¼Œä¹‹å¾Œå¯é›¢ç·šä½¿ç”¨ã€‚</p>
    </div>
</div>

<script type="module">
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js';

    // é›¢ç·šé—œéµè¨­å®š
    env.allowLocalModels = false;
    env.useBrowserCache = true;

    const $ = id => document.getElementById(id);
    const statusText = $('statusText');
    const loadBtn = $('loadBtn');
    const runBtn = $('runBtn');
    const uploadInput = $('uploadInput');
    const imageCanvas = $('imageCanvas');
    const maskCanvas = $('maskCanvas');
    const loader = $('loader');
    const loaderText = $('loaderText');
    const legendArea = $('legendArea');
    const legendTags = $('legendTags');
    const imgContainer = $('imgContainer');

    let segmenter = null;
    let rawImage = null; 

    // 1. è¼‰å…¥æ¨¡å‹
    loadBtn.addEventListener('click', async () => {
        try {
            loadBtn.disabled = true;
            loadBtn.textContent = "æ¨¡å‹ä¸‹è¼‰ä¸­...";
            statusText.textContent = "æ­£åœ¨ä¸‹è¼‰æ¨¡å‹...";
            
            // ä½¿ç”¨ SegFormer æ¨¡å‹
            segmenter = await pipeline('image-segmentation', 'Xenova/segformer-b0-finetuned-ade-512-512', {
                progress_callback: (data) => {
                    if (data.status === 'progress') {
                        const pct = Math.round(data.progress || 0);
                        loadBtn.textContent = `ä¸‹è¼‰ä¸­... ${pct}%`;
                    }
                }
            });

            statusText.textContent = "æ¨¡å‹å·²å°±ç·’ (é›¢ç·šå¯ç”¨)";
            loadBtn.style.display = 'none';
            runBtn.disabled = false;
            
            if (rawImage) runBtn.click();

        } catch (err) {
            console.error(err);
            statusText.textContent = "è¼‰å…¥å¤±æ•—";
            loadBtn.textContent = "é‡è©¦ä¸‹è¼‰";
            loadBtn.disabled = false;
            alert("æ¨¡å‹ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥ã€‚");
        }
    });

    // 2. è™•ç†åœ–ç‰‡
    uploadInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const maxSize = 800; // é™åˆ¶å¤§å°å„ªåŒ–æ•ˆèƒ½
                let w = img.width;
                let h = img.height;
                
                if (w > maxSize || h > maxSize) {
                    const ratio = Math.min(maxSize / w, maxSize / h);
                    w *= ratio;
                    h *= ratio;
                }

                imageCanvas.width = w;
                imageCanvas.height = h;
                maskCanvas.width = w;
                maskCanvas.height = h;

                const ctx = imageCanvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                
                const mCtx = maskCanvas.getContext('2d');
                mCtx.clearRect(0, 0, w, h);
                
                imgContainer.querySelector('div').style.display = 'none';
                legendArea.style.display = 'none';

                rawImage = imageCanvas.toDataURL('image/jpeg');

                if (segmenter) runBtn.disabled = false;
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    // 3. åŸ·è¡Œé æ¸¬
    runBtn.addEventListener('click', async () => {
        if (!segmenter || !rawImage) {
            alert("è«‹å…ˆè¼‰å…¥æ¨¡å‹ä¸¦é¸åœ–");
            return;
        }

        loader.style.display = 'flex';
        loaderText.textContent = "AI è­˜åˆ¥ä¸­...";
        runBtn.disabled = true;

        try {
            const output = await segmenter(rawImage);
            console.log("Segment Output:", output);
            drawSegmentation(output);
        } catch (err) {
            console.error(err);
            alert("åˆ†æéŒ¯èª¤: " + err.message);
        } finally {
            loader.style.display = 'none';
            runBtn.disabled = false;
        }
    });

    // 4. ç¹ªè£½é®ç½© (ä¿®æ­£ç‰ˆï¼šè™•ç† Grayscale -> RGBA)
    function drawSegmentation(results) {
        const ctx = maskCanvas.getContext('2d');
        const w = maskCanvas.width;
        const h = maskCanvas.height;
        ctx.clearRect(0, 0, w, h);
        
        legendTags.innerHTML = '';

        results.forEach((item, index) => {
            const { label, mask } = item;
            
            const hue = (index * 137.5) % 360;
            const color = `hsla(${hue}, 70%, 50%, 0.6)`; 
            const solidColor = `hsl(${hue}, 70%, 50%)`;

            // --- é—œéµä¿®æ­£ï¼šå°‡ 1-channel mask è½‰æ›ç‚º 4-channel RGBA ---
            const pixelCount = mask.width * mask.height;
            const rgbaData = new Uint8ClampedArray(pixelCount * 4);
            
            for (let i = 0; i < pixelCount; i++) {
                const val = mask.data[i];
                if (val > 0) {
                    // ä½¿ç”¨ç™½è‰² (255,255,255) é…åˆ alpha
                    // ä¹‹å¾Œæœƒç”¨ tint æŸ“è‰²
                    rgbaData[i * 4] = 255;     // R
                    rgbaData[i * 4 + 1] = 255; // G
                    rgbaData[i * 4 + 2] = 255; // B
                    rgbaData[i * 4 + 3] = 255; // A (å®Œå…¨ä¸é€æ˜ï¼Œå› ç‚ºæˆ‘å€‘ç”¨ composite æŸ“è‰²)
                } else {
                    rgbaData[i * 4 + 3] = 0;   // A (é€æ˜)
                }
            }
            
            const imgData = new ImageData(rgbaData, mask.width, mask.height);
            // -------------------------------------------------------

            // å»ºç«‹æš«å­˜ Canvas
            const maskCanvasElem = document.createElement('canvas');
            maskCanvasElem.width = mask.width;
            maskCanvasElem.height = mask.height;
            const maskCtx = maskCanvasElem.getContext('2d');
            maskCtx.putImageData(imgData, 0, 0);

            // æŸ“è‰²èˆ‡åˆæˆ
            ctx.save();
            
            const tempC = document.createElement('canvas');
            tempC.width = w;
            tempC.height = h;
            const tCtx = tempC.getContext('2d');
            
            // ç¸®æ”¾ä¸¦ç¹ªè£½é®ç½©
            tCtx.drawImage(maskCanvasElem, 0, 0, w, h);
            
            // ä½¿ç”¨ source-in åªåœ¨æœ‰é®ç½©çš„åœ°æ–¹ä¸Šè‰²
            tCtx.globalCompositeOperation = 'source-in';
            tCtx.fillStyle = color;
            tCtx.fillRect(0, 0, w, h);
            
            // ç•«å›ä¸»å±¤
            ctx.drawImage(tempC, 0, 0);
            ctx.restore();

            // æ–°å¢ Tag
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.style.backgroundColor = solidColor;
            tag.textContent = label;
            legendTags.appendChild(tag);
        });

        legendArea.style.display = 'block';
    }
</script>

</body>
</html>
